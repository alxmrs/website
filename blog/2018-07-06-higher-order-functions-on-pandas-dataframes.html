<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2018-07-06" />
  <title>Alex Rosengarten</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #232629;
    color: #7a7c7d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #7a7c7d;  padding-left: 4px; }
div.sourceCode
  { color: #cfcfc2; background-color: #232629; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span. { color: #cfcfc2; } /* Normal */
code span.al { color: #95da4c; } /* Alert */
code span.an { color: #3f8058; } /* Annotation */
code span.at { color: #2980b9; } /* Attribute */
code span.bn { color: #f67400; } /* BaseN */
code span.bu { color: #7f8c8d; } /* BuiltIn */
code span.cf { color: #fdbc4b; } /* ControlFlow */
code span.ch { color: #3daee9; } /* Char */
code span.cn { color: #27aeae; } /* Constant */
code span.co { color: #7a7c7d; } /* Comment */
code span.cv { color: #7f8c8d; } /* CommentVar */
code span.do { color: #a43340; } /* Documentation */
code span.dt { color: #2980b9; } /* DataType */
code span.dv { color: #f67400; } /* DecVal */
code span.er { color: #da4453; } /* Error */
code span.ex { color: #0099ff; } /* Extension */
code span.fl { color: #f67400; } /* Float */
code span.fu { color: #8e44ad; } /* Function */
code span.im { color: #27ae60; } /* Import */
code span.in { color: #c45b00; } /* Information */
code span.kw { color: #cfcfc2; } /* Keyword */
code span.op { color: #cfcfc2; } /* Operator */
code span.ot { color: #27ae60; } /* Other */
code span.pp { color: #27ae60; } /* Preprocessor */
code span.re { color: #2980b9; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #da4453; } /* SpecialString */
code span.st { color: #f44f4f; } /* String */
code span.va { color: #27aeae; } /* Variable */
code span.vs { color: #da4453; } /* VerbatimString */
code span.wa { color: #da4453; } /* Warning */
  </style>
  <link rel="stylesheet" href="/css/main.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<!-- Checking out my source, eh? Please, feel free to see how this was made here: https://github.com/alxrsngrtn/alxrsngrtn.github.io -->
<!-- While I have you, why don't you say "Hi" to me on email or twitter? We can talk about tech, life, or whatever you'd like. -->
<nav>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/blog">Blog</a></li>
        <li class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox"/>
                <div class="slider round"></div>
            </label>
        </li>
    </ul>
</nav>
<header>
<h1 class="title">Higher Order Functions on Pandas Dataframes</h1>
<p class="date">2018-07-06</p>
</header>
<p>(Note: the following article is unedited – Proceed with caution).</p>
<p>(Last updated: 2018-07-31)</p>
<h2 id="motivation">Motivation</h2>
<p>I wrote this article to capture a perspective on dataframes that I think most Python developers – especially data scientists – overlook.</p>
<p>Working closely with data often lends itself to tight coupling to the structure of that data. With this comes messy, brittle code.</p>
<p>I contend that there is a better way; a way that promotes modular, flexible, and testable code; a method where we can automate away the boring parts and think clearly about the problem at hand.</p>
<p>The core idea is to promote re-use of logic through composition. To this end, we treat functions as data. We must also try as much as possible to abstract away the nonessential details of each operation.</p>
<p>I’m getting ahead of myself. It’s better to <em>show</em> rather than <em>tell</em>. Let’s explore the thought process of refactoring the standard method for querying data in Pandas.</p>
<h2 id="the-conventional-way">The Conventional Way</h2>
<p>The Pandas documentation explains the similarities between their API and SQL for querying tabular data. A SQL query with a compound <code>WHERE</code> clause, for instance, can be expressed as follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">-- tips of more than $5.00 at Dinner meals</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">SELECT</span> *</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">FROM</span> tips</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">WHERE</span> <span class="dt">time</span> = <span class="st">&#39;Dinner&#39;</span> <span class="kw">AND</span> tip &gt; <span class="fl">5.00</span>;</a></code></pre></div>
<p>The equivalent Pandas syntax is as such:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># tips of more than $5.00 at Dinner meals</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> In [<span class="dv">11</span>]: tips[(tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>) <span class="op">&amp;</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>)]</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">     total_bill    tip     sex smoker  day    time  size</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></a></code></pre></div>
<p><a href="https://pandas.pydata.org/pandas-docs/stable/comparison_with_sql.html#where">(source)</a></p>
<p>What if we wanted to extend our query with an arbitrary number of conditions?</p>
<p>Using the standard Pandas syntax, it would look something like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> tips[(tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>) <span class="op">&amp;</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">...      (tips[<span class="st">&#39;sex&#39;</span>] <span class="op">==</span> <span class="st">&#39;Female&#39;</span>)  <span class="op">&amp;</span> (tips[<span class="st">&#39;smoker&#39;</span>] <span class="op">==</span> <span class="st">&#39;No&#39;</span>)]</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">     total_bill   tip     sex smoker  day    time  size</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="dv">52</span>        <span class="fl">34.81</span>  <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="dv">155</span>       <span class="fl">29.85</span>  <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></a></code></pre></div>
<p>This does not seem ideal. Our line of code quickly gets longer as we add more filtering logic. A lot of logic is repeated – namely, we keep referring to the <code>tips</code> dataframe over and over. What if the dataframe name changed? Or we wanted to apply the same query to another, similar table?</p>
<p>This would double our work: We would need to re-write the whole line substituting one variable name for the other. Or worse, we could swap the data each variable refers to.</p>
<p>How can we provide a more succinct interface for querying data? How can we make sure that it is intuitive, general, and correct?</p>
<h2 id="breaking-down-the-problem">Breaking Down The Problem</h2>
<p>Let’s break down what’s going on in the above query:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> is_dinner_time <span class="op">=</span> (tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> is_dinner_time.head()</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="dv">0</span>    <span class="va">True</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="dv">1</span>    <span class="va">True</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="dv">2</span>    <span class="va">True</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="dv">3</span>    <span class="va">True</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="dv">4</span>    <span class="va">True</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">Name: time, dtype: <span class="bu">bool</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="op">&gt;&gt;&gt;</span> is_dinner_time.value_counts()</a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="va">True</span>     <span class="dv">176</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="va">False</span>     <span class="dv">68</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">Name: time, dtype: int64</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="op">&gt;&gt;&gt;</span> is_tip_above_five <span class="op">=</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>)</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="op">&gt;&gt;&gt;</span> is_tip_above_five.head()</a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="dv">0</span>    <span class="va">False</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="dv">1</span>    <span class="va">False</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="dv">2</span>    <span class="va">False</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="dv">3</span>    <span class="va">False</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="dv">4</span>    <span class="va">False</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">Name: tip, dtype: <span class="bu">bool</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="op">&gt;&gt;&gt;</span> is_tip_above_five.value_counts()</a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="va">False</span>    <span class="dv">226</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="va">True</span>      <span class="dv">18</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24">Name: tip, dtype: int64</a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="op">&gt;&gt;&gt;</span> <span class="co"># etc...</span></a></code></pre></div>
<p>Ah! So what’s actually going on is we are taking advantage of dataframe’s capacity for <a href="https://pandas.pydata.org/pandas-docs/stable/10min.html#boolean-indexing">boolean indexing</a>.</p>
<p>What if we could use this to abstract away which dataframe we are acting on? Certainly, we’d prefer to only focus on the filtering logic rather than housekeeping. Plus, we might like to reuse the query on different dataframes.</p>
<p>Let’s try this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> is_dinner_time <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> is_tip_above_five <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> tips[is_dinner_time(tips) <span class="op">&amp;</span> is_tip_above_five(tips)]</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">     total_bill    tip     sex smoker  day    time  size</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12"><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15"><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19"><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></a></code></pre></div>
<p>Great. I now have two functions <code>is_dinner_time</code> and <code>is_tip_above_five</code> which I could use on any other dataframe. However, I still am repeating the reference to <code>tips</code> as many times as I did before. How can I get rid of this grunt work? Ideally, I would like to refer to a dataframe once, mixing in the filter operations and I see fit.</p>
<h2 id="towards-generalization">Towards Generalization</h2>
<p>Why not use a <a href="https://en.wikipedia.org/wiki/Higher-order_function">higher-order function</a>? Functions are first class citizens in python, after all. Let’s abstract away the rote work of calling these filter functions with respect to a particular dataframe.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> functools</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> intersection(df, <span class="op">*</span>filters):</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">...    mapped_boolean_dfs <span class="op">=</span> [f(df) <span class="cf">for</span> f <span class="kw">in</span> filters <span class="cf">if</span> <span class="bu">callable</span>(f)]</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">...    accumulated_boolean_df <span class="op">=</span> functools.<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, d: acc <span class="op">&amp;</span> d, mapped_boolean_dfs)</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">...    <span class="cf">return</span> df[accumulated_boolean_df]</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="op">&gt;&gt;&gt;</span> intersection(tips, is_dinner_time, is_tip_above_five)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">     total_bill    tip     sex smoker  day    time  size</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19"><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb6-21" data-line-number="21"><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb6-22" data-line-number="22"><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></a></code></pre></div>
<p>Much better. Now, should we want to add additional fields in the table to filter with, we merely define more filter functions – which, again, can be used for any table.</p>
<p>Please note that each functions can be as complicated as we want, as long as they return a dataframe of booleans the same size as the input.</p>
<p>For example, if we are querying string data that is messy, we could write a filter like the following:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> is_dinner_fuzzy(df):</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">...    <span class="cf">return</span> df[<span class="st">&#39;time&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: fuzz.ratio(x, <span class="st">&#39;dinner&#39;</span>)) <span class="op">&gt;=</span> <span class="dv">90</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> intersection(tips, is_dinner_fuzzy, is_tip_above_five)</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">     total_bill    tip     sex smoker  day    time  size</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-8" data-line-number="8"><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb7-14" data-line-number="14"><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></a>
<a class="sourceLine" id="cb7-15" data-line-number="15"><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-16" data-line-number="16"><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-17" data-line-number="17"><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb7-19" data-line-number="19"><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></a></code></pre></div>
<p>(Note: <code>fuzz.ratio()</code> returns an integer representing the <a href="https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein distance</a> from one string to another)</p>
<h2 id="how-general-can-we-go">How General Can We Go?</h2>
<p>Is our intersection general enough? What if we wanted to query our data but instead of using a SQL-like <code>AND</code> operation, we wanted an <code>OR</code> operation?</p>
<p>Let’s generalize further:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">&amp;</span> x):</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">...    mapped_dfs <span class="op">=</span> [f(df) <span class="cf">for</span> f <span class="kw">in</span> filters <span class="cf">if</span> <span class="bu">callable</span>(f)]</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">...    accumulated_df <span class="op">=</span> functools.<span class="bu">reduce</span>(reducer, mapped_dfs)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">...    <span class="cf">return</span> df[accumulated_df]</a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> intersection(df, <span class="op">*</span>filters):</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">...    <span class="cf">return</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">&amp;</span> x)</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> union(df, <span class="op">*</span>filters):</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">...    <span class="cf">return</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">|</span> x)</a></code></pre></div>
<p>Then we can represent the following SQL query (from the Pandas documentation) like so:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">SELECT</span> *</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">FROM</span> tips</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">WHERE</span> <span class="kw">size</span> &gt;= <span class="dv">5</span> <span class="kw">OR</span> total_bill &gt; <span class="dv">45</span>;</a></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> is_total_bill_large <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;total_bill&#39;</span>] <span class="op">&gt;</span> <span class="dv">45</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> is_party_gte_five <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;size&#39;</span>] <span class="op">&gt;=</span> <span class="dv">5</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> union(tips, is_party_gte_five, is_total_bill_large)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">     total_bill    tip     sex smoker   day    time  size</a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No   Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="dv">125</span>       <span class="fl">29.80</span>   <span class="fl">4.20</span>  Female     No  Thur   Lunch     <span class="dv">6</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="dv">141</span>       <span class="fl">34.30</span>   <span class="fl">6.70</span>    Male     No  Thur   Lunch     <span class="dv">6</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="dv">142</span>       <span class="fl">41.19</span>   <span class="fl">5.00</span>    Male     No  Thur   Lunch     <span class="dv">5</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="dv">143</span>       <span class="fl">27.05</span>   <span class="fl">5.00</span>  Female     No  Thur   Lunch     <span class="dv">6</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No   Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="dv">156</span>       <span class="fl">48.17</span>   <span class="fl">5.00</span>    Male     No   Sun  Dinner     <span class="dv">6</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes   Sat  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="dv">182</span>       <span class="fl">45.35</span>   <span class="fl">3.50</span>    Male    Yes   Sun  Dinner     <span class="dv">3</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="dv">185</span>       <span class="fl">20.69</span>   <span class="fl">5.00</span>    Male     No   Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="dv">187</span>       <span class="fl">30.46</span>   <span class="fl">2.00</span>    Male    Yes   Sun  Dinner     <span class="dv">5</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No   Sat  Dinner     <span class="dv">4</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="dv">216</span>       <span class="fl">28.15</span>   <span class="fl">3.00</span>    Male    Yes   Sat  Dinner     <span class="dv">5</span></a></code></pre></div>
<p>Sure, we could have implemented the <code>union</code> and <code>intersection</code> cases by themselves, but the function <code>filter_reduce</code> offers us the luxury of adaptability later on.</p>
<h2 id="beyond-querying">Beyond Querying</h2>
<p>Can this perspective help with other problems besides querying?</p>
<p>Often, we need to mutate dataframes. We might want to add a column of derived values, or change a column’s data type. Mutability, however, comes with several challenges: What if we make a mistake when mutating the dataframe, and we would like to revert to the previous form? What if we wanted to know what the original data looked like?</p>
<p>In Pandas, we can simulate immutability by creating mapping functions that first perform a shallow copy of the input dataframe and return a new result.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> add_subtotal(df):</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">...     cp[<span class="st">&#39;subtotal&#39;</span>] <span class="op">=</span> cp[<span class="st">&#39;total_bill&#39;</span>] <span class="op">-</span> cp[<span class="st">&#39;tip&#39;</span>]</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">...     <span class="cf">return</span> cp</a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="op">&gt;&gt;&gt;</span> tips1 <span class="op">=</span> add_subtotal(tips)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="op">&gt;&gt;&gt;</span> tips1.head()</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">   total_bill   tip     sex smoker  day    time  size  subtotal</a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male     No  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male     No  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12"><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female     No  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> add_avg_bill(df): </a>
<a class="sourceLine" id="cb11-14" data-line-number="14">...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">...     cp[<span class="st">&#39;price_per_person&#39;</span>] <span class="op">=</span> cp[<span class="st">&#39;subtotal&#39;</span>] <span class="op">/</span> cp[<span class="st">&#39;size&#39;</span>]</a>
<a class="sourceLine" id="cb11-16" data-line-number="16">...     <span class="cf">return</span> cp</a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="op">&gt;&gt;&gt;</span> tips2 <span class="op">=</span> add_avg_bill(tips1)</a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="op">&gt;&gt;&gt;</span> tips2.head()</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">   total_bill   tip     sex smoker  day    time  size  subtotal  <span class="op">\</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </a>
<a class="sourceLine" id="cb11-21" data-line-number="21"><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male     No  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male     No  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </a>
<a class="sourceLine" id="cb11-24" data-line-number="24"><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female     No  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </a>
<a class="sourceLine" id="cb11-25" data-line-number="25">   price_per_person  </a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="dv">0</span>          <span class="fl">7.990000</span>  </a>
<a class="sourceLine" id="cb11-27" data-line-number="27"><span class="dv">1</span>          <span class="fl">2.893333</span>  </a>
<a class="sourceLine" id="cb11-28" data-line-number="28"><span class="dv">2</span>          <span class="fl">5.836667</span>  </a>
<a class="sourceLine" id="cb11-29" data-line-number="29"><span class="dv">3</span>         <span class="fl">10.185000</span>  </a>
<a class="sourceLine" id="cb11-30" data-line-number="30"><span class="dv">4</span>          <span class="fl">5.245000</span>  </a>
<a class="sourceLine" id="cb11-31" data-line-number="31"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> yesno_to_bool(df, column<span class="op">=</span><span class="st">&#39;smoker&#39;</span>):</a>
<a class="sourceLine" id="cb11-32" data-line-number="32">...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb11-33" data-line-number="33">...     cp[column] <span class="op">=</span> cp[column].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="op">==</span> <span class="st">&#39;Yes&#39;</span>)</a>
<a class="sourceLine" id="cb11-34" data-line-number="34">...     <span class="cf">return</span> cp</a>
<a class="sourceLine" id="cb11-35" data-line-number="35"><span class="op">&gt;&gt;&gt;</span> tips3 <span class="op">=</span> yesno_to_bool(tips2, <span class="st">&#39;smoker&#39;</span>)</a>
<a class="sourceLine" id="cb11-36" data-line-number="36"><span class="op">&gt;&gt;&gt;</span> tips3.head()</a>
<a class="sourceLine" id="cb11-37" data-line-number="37">Out[<span class="dv">52</span>]: </a>
<a class="sourceLine" id="cb11-38" data-line-number="38">   total_bill   tip     sex  smoker  day    time  size  subtotal  <span class="op">\</span></a>
<a class="sourceLine" id="cb11-39" data-line-number="39"><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </a>
<a class="sourceLine" id="cb11-40" data-line-number="40"><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </a>
<a class="sourceLine" id="cb11-41" data-line-number="41"><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </a>
<a class="sourceLine" id="cb11-42" data-line-number="42"><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </a>
<a class="sourceLine" id="cb11-43" data-line-number="43"><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </a>
<a class="sourceLine" id="cb11-44" data-line-number="44">   price_per_person  </a>
<a class="sourceLine" id="cb11-45" data-line-number="45"><span class="dv">0</span>          <span class="fl">7.990000</span>  </a>
<a class="sourceLine" id="cb11-46" data-line-number="46"><span class="dv">1</span>          <span class="fl">2.893333</span>  </a>
<a class="sourceLine" id="cb11-47" data-line-number="47"><span class="dv">2</span>          <span class="fl">5.836667</span>  </a>
<a class="sourceLine" id="cb11-48" data-line-number="48"><span class="dv">3</span>         <span class="fl">10.185000</span>  </a>
<a class="sourceLine" id="cb11-49" data-line-number="49"><span class="dv">4</span>          <span class="fl">5.245000</span>  </a></code></pre></div>
<p>…</p>
<p>We can combine all of these – and arbitrarily more operations – through a higher order function called <code>compose</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> functools</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> compose(df, <span class="op">*</span>mappers):</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">...     <span class="cf">return</span> functools.<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, x: x(acc), mappers, df)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="op">&gt;&gt;&gt;</span> tips_all <span class="op">=</span> compose(tips, add_subtotal, add_avg_bill, <span class="kw">lambda</span> x: yesno_to_bool(x, <span class="st">&#39;smoker&#39;</span>))</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="op">&gt;&gt;&gt;</span> tips_all.head()</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">   total_bill   tip     sex  smoker  day    time  size  subtotal  <span class="op">\</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </a>
<a class="sourceLine" id="cb12-12" data-line-number="12">   price_per_person  </a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="dv">0</span>          <span class="fl">7.990000</span>  </a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="dv">1</span>          <span class="fl">2.893333</span>  </a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="dv">2</span>          <span class="fl">5.836667</span>  </a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="dv">3</span>         <span class="fl">10.185000</span>  </a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="dv">4</span>          <span class="fl">5.245000</span>  </a></code></pre></div>
<p>One advantage of this approach is that mutating dataframes can be lazily evaluated: We can wait to modify the data only until it’s needed (i.e. until we call <code>compose</code>).</p>
<p>Another advantage is that we preserve all the intermediate states of the data. Further, we have complete flexibility as to what mappings get applied. Decide that we want to keep the <code>smokers</code> column as strings again? – Just remove the <code>yesno_to_bool</code> function. Decide that you’d rather map it to <code>int</code>s? – Simply swap out the function. Just like the filter functions, these mappers can be applied to any dataframe, provided they have the correct columns.</p>
<p>It’s worth wondering: Is copying all of the data inefficient? Surely, we don’t want to duplicate the data all over the place, especially if the corpus is large.</p>
<p>Pandas addresses this in a very clever manner. The constructor performs a lazy copy! The copied dataframes store references to the original values. Only when the data gets mutated does it decide to allocate new memory. In other words, only the <em>differences</em> from one dataframe to another are stored. Thus, representing transformations with copies remains efficient while promoting many other benefits.</p>
<p>Don’t take my word for it! Let’s prove that this is the case:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> tips_ref_original <span class="op">=</span> tips.applymap(<span class="bu">id</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> tips_ref_copied <span class="op">=</span> tips_all.applymap(<span class="bu">id</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> tips_ref_original.head()</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">    total_bill              tip              sex           smoker  <span class="op">\</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="dv">0</span>  <span class="dv">139919566582840</span>  <span class="dv">139919566583392</span>  <span class="dv">139919566677192</span>  <span class="dv">139919567009976</span>   </a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="dv">1</span>  <span class="dv">139919566584736</span>  <span class="dv">139919566583416</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="dv">2</span>  <span class="dv">139919566584760</span>  <span class="dv">139919566583440</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="dv">3</span>  <span class="dv">139919566584808</span>  <span class="dv">139919566583464</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="dv">4</span>  <span class="dv">139919566584832</span>  <span class="dv">139919566583488</span>  <span class="dv">139919566677192</span>  <span class="dv">139919567009976</span>   </a>
<a class="sourceLine" id="cb13-10" data-line-number="10">               day             time            size  </a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="dv">0</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  </a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="dv">1</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  </a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="dv">2</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  </a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="dv">3</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  </a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="dv">4</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979424</span>  </a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="op">&gt;&gt;&gt;</span> tips_ref_copied.head()</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">        total_bill              tip              sex          smoker  <span class="op">\</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="dv">0</span>  <span class="dv">139919450679696</span>  <span class="dv">139919450735360</span>  <span class="dv">139919566677192</span>  <span class="dv">94289170711232</span>   </a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="dv">1</span>  <span class="dv">139919450679720</span>  <span class="dv">139919450735336</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="dv">2</span>  <span class="dv">139919450679744</span>  <span class="dv">139919450735312</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="dv">3</span>  <span class="dv">139919450679768</span>  <span class="dv">139919450735288</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="dv">4</span>  <span class="dv">139919450679792</span>  <span class="dv">139919450735264</span>  <span class="dv">139919566677192</span>  <span class="dv">94289170711232</span>   </a>
<a class="sourceLine" id="cb13-23" data-line-number="23">               day             time            size         subtotal  <span class="op">\</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="dv">0</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  <span class="dv">139919450679696</span>   </a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="dv">1</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  <span class="dv">139919450679720</span>   </a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="dv">2</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  <span class="dv">139919450679744</span>   </a>
<a class="sourceLine" id="cb13-27" data-line-number="27"><span class="dv">3</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  <span class="dv">139919450679768</span>   </a>
<a class="sourceLine" id="cb13-28" data-line-number="28"><span class="dv">4</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979424</span>  <span class="dv">139919450679792</span>   </a>
<a class="sourceLine" id="cb13-29" data-line-number="29">   price_per_person  </a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="dv">0</span>   <span class="dv">139919450735360</span>  </a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="dv">1</span>   <span class="dv">139919450735336</span>  </a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="dv">2</span>   <span class="dv">139919450735312</span>  </a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="dv">3</span>   <span class="dv">139919450735288</span>  </a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="dv">4</span>   <span class="dv">139919450735264</span>  </a>
<a class="sourceLine" id="cb13-35" data-line-number="35"><span class="op">&gt;&gt;&gt;</span> tips_xor <span class="op">=</span> tips_ref_original <span class="op">^</span> tips_ref_copied</a>
<a class="sourceLine" id="cb13-36" data-line-number="36"><span class="op">&gt;&gt;&gt;</span> tips_xor.head()</a>
<a class="sourceLine" id="cb13-37" data-line-number="37">   day  price_per_person  sex  size          smoker  subtotal  time  <span class="op">\</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38"><span class="dv">0</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </a>
<a class="sourceLine" id="cb13-39" data-line-number="39"><span class="dv">1</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </a>
<a class="sourceLine" id="cb13-40" data-line-number="40"><span class="dv">2</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </a>
<a class="sourceLine" id="cb13-41" data-line-number="41"><span class="dv">3</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </a>
<a class="sourceLine" id="cb13-42" data-line-number="42"><span class="dv">4</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </a>
<a class="sourceLine" id="cb13-43" data-line-number="43">         tip  total_bill  </a>
<a class="sourceLine" id="cb13-44" data-line-number="44"><span class="dv">0</span>  <span class="dv">423146848</span>   <span class="dv">423075240</span>  </a>
<a class="sourceLine" id="cb13-45" data-line-number="45"><span class="dv">1</span>  <span class="dv">423146640</span>   <span class="dv">423072264</span>  </a>
<a class="sourceLine" id="cb13-46" data-line-number="46"><span class="dv">2</span>  <span class="dv">423146560</span>   <span class="dv">423072376</span>  </a>
<a class="sourceLine" id="cb13-47" data-line-number="47"><span class="dv">3</span>  <span class="dv">423146512</span>   <span class="dv">423072304</span>  </a>
<a class="sourceLine" id="cb13-48" data-line-number="48"><span class="dv">4</span>  <span class="dv">423146592</span>   <span class="dv">423073264</span>  </a></code></pre></div>
<footer>
    <ul>
        <li><script type="text/javascript">
            <!--
            h='&#x67;&#x6d;&#x61;&#x69;&#108;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x61;&#108;&#120;&#114;&#x73;&#110;&#x67;&#114;&#116;&#110;&#x2b;&#112;&#x77;';e=n+a+h;
            document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+'gmail'+'<\/'+'a'+'>');
            // -->
        </script><noscript>&#x61;&#108;&#120;&#114;&#x73;&#110;&#x67;&#114;&#116;&#110;&#x2b;&#112;&#x77;&#32;&#x61;&#116;&#32;&#x67;&#x6d;&#x61;&#x69;&#108;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript></li>
        <li><script type="text/javascript">
            <!--
            h='&#x67;&#x6f;&#x6f;&#x67;&#108;&#x65;&#46;&#x63;&#x6f;&#x6d;';a='&#64;';n='&#x61;&#108;&#120;&#114;';e=n+a+h;
            document.write('<a h'+'ref'+'="ma'+'ilto'+':'+e+'" clas'+'s="em' + 'ail">'+'google'+'<\/'+'a'+'>');
            // -->
        </script><noscript>&#x61;&#108;&#120;&#114;&#32;&#x61;&#116;&#32;&#x67;&#x6f;&#x6f;&#x67;&#108;&#x65;&#32;&#100;&#x6f;&#116;&#32;&#x63;&#x6f;&#x6d;</noscript></li>
        </li>
        <li><a href="https://github.com/alxrsngrtn">github</a></li>
        <li><a href="https://twitter.com/alxrsngrtn">twitter</a></li>
        <li><a href="https://github.com/alxrsngrtn/Resumes/releases/">resume</a></li>
    </ul>
</footer>
<script type="text/javascript" src="/js/theme.js" async></script>
</body>
</html>
