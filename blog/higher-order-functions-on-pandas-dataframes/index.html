<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="dcterms.date" content="2018-07-31" />
  <title>Higher Order Functions on Pandas Dataframes</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="/css/main.css" />
  <meta property="og:image" content="/assets/kraftwerk.webp">
</head>
<body>
<nav>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/faqs">FAQs</a></li>
        <li><a href="/talks">Talks</a></li>
        <li><a href="/blog">Blog</a></li>
        <li><a href="/cv">CV</a></li>
        <li><a href="javascript:if(window.print)window.print()">üñ®Ô∏è</a></li>
    </ul>
</nav>

<header id="title-block-header">
<h1 class="title">Higher Order Functions on Pandas Dataframes</h1>
<p class="date">2018-07-31</p>
</header>
<p>(Note: the following article is unedited -- Proceed with
caution).</p>
<p>(Last updated: 2018-07-31)</p>
<h2 id="motivation">Motivation</h2>
<p>I wrote this article to capture a perspective on dataframes that I
think most Python developers -- especially data scientists --
overlook.</p>
<p>Working closely with data often lends itself to tight coupling to the
structure of that data. With this comes messy, brittle code.</p>
<p>I contend that there is a better way; a way that promotes modular,
flexible, and testable code; a method where we can automate away the
boring parts and think clearly about the problem at hand.</p>
<p>The core idea is to promote re-use of logic through composition. To
this end, we treat functions as data. We must also try as much as
possible to abstract away the nonessential details of each
operation.</p>
<p>I'm getting ahead of myself. It's better to <em>show</em> rather than
<em>tell</em>. Let's explore the thought process of refactoring the
standard method for querying data in Pandas.</p>
<h2 id="the-conventional-way">The Conventional Way</h2>
<p>The Pandas documentation explains the similarities between their API
and SQL for querying tabular data. A SQL query with a compound
<code>WHERE</code> clause, for instance, can be expressed as
follows:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode SQL"><code class="sourceCode sql"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- tips of more than $5.00 at Dinner meals</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tips</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="dt">time</span> <span class="op">=</span> <span class="st">&#39;Dinner&#39;</span> <span class="kw">AND</span> tip <span class="op">&gt;</span> <span class="fl">5.00</span>;</span></code></pre></div>
<p>The equivalent Pandas syntax is as such:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tips of more than $5.00 at Dinner meals</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> In [<span class="dv">11</span>]: tips[(tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>) <span class="op">&amp;</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>)]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>     total_bill    tip     sex smoker  day    time  size</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></span></code></pre></div>
<p><a
href="/https://pandas.pydata.org/pandas-docs/stable/comparison_with_sql.html#where">(source)</a></p>
<p>What if we wanted to extend our query with an arbitrary number of
conditions?</p>
<p>Using the standard Pandas syntax, it would look something like
this:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips[(tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>) <span class="op">&amp;</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>) <span class="op">&amp;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>...      (tips[<span class="st">&#39;sex&#39;</span>] <span class="op">==</span> <span class="st">&#39;Female&#39;</span>)  <span class="op">&amp;</span> (tips[<span class="st">&#39;smoker&#39;</span>] <span class="op">==</span> <span class="st">&#39;No&#39;</span>)]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     total_bill   tip     sex smoker  day    time  size</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="dv">52</span>        <span class="fl">34.81</span>  <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>  <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></span></code></pre></div>
<p>This does not seem ideal. Our line of code quickly gets longer as we
add more filtering logic. A lot of logic is repeated -- namely, we keep
referring to the <code>tips</code> dataframe over and over. What if the
dataframe name changed? Or we wanted to apply the same query to another,
similar table?</p>
<p>This would double our work: We would need to re-write the whole line
substituting one variable name for the other. Or worse, we could swap
the data each variable refers to.</p>
<p>How can we provide a more succinct interface for querying data? How
can we make sure that it is intuitive, general, and correct?</p>
<h2 id="breaking-down-the-problem">Breaking Down The Problem</h2>
<p>Let's break down what's going on in the above query:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_dinner_time <span class="op">=</span> (tips[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_dinner_time.head()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>    <span class="va">True</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>    <span class="va">True</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>    <span class="va">True</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>    <span class="va">True</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>    <span class="va">True</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>Name: time, dtype: <span class="bu">bool</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_dinner_time.value_counts()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="va">True</span>     <span class="dv">176</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="va">False</span>     <span class="dv">68</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>Name: time, dtype: int64</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_tip_above_five <span class="op">=</span> (tips[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_tip_above_five.head()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>    <span class="va">False</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>    <span class="va">False</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>    <span class="va">False</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>    <span class="va">False</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>    <span class="va">False</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>Name: tip, dtype: <span class="bu">bool</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_tip_above_five.value_counts()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="va">False</span>    <span class="dv">226</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="va">True</span>      <span class="dv">18</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>Name: tip, dtype: int64</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="co"># etc...</span></span></code></pre></div>
<p>Ah! So what's actually going on is we are taking advantage of
dataframe's capacity for <a
href="/https://pandas.pydata.org/pandas-docs/stable/10min.html#boolean-indexing">boolean
indexing</a>.</p>
<p>What if we could use this to abstract away which dataframe we are
acting on? Certainly, we'd prefer to only focus on the filtering logic
rather than housekeeping. Plus, we might like to reuse the query on
different dataframes.</p>
<p>Let's try this:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_dinner_time <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;time&#39;</span>] <span class="op">==</span> <span class="st">&#39;Dinner&#39;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_tip_above_five <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;tip&#39;</span>] <span class="op">&gt;</span> <span class="fl">5.00</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips[is_dinner_time(tips) <span class="op">&amp;</span> is_tip_above_five(tips)]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>     total_bill    tip     sex smoker  day    time  size</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></span></code></pre></div>
<p>Great. I now have two functions <code>is_dinner_time</code> and
<code>is_tip_above_five</code> which I could use on any other dataframe.
However, I still am repeating the reference to <code>tips</code> as many
times as I did before. How can I get rid of this grunt work? Ideally, I
would like to refer to a dataframe once, mixing in the filter operations
and I see fit.</p>
<h2 id="towards-generalization">Towards Generalization</h2>
<p>Why not use a <a
href="/https://en.wikipedia.org/wiki/Higher-order_function">higher-order
function</a>? Functions are first class citizens in python, after all.
Let's abstract away the rote work of calling these filter functions with
respect to a particular dataframe.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> functools</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> intersection(df, <span class="op">*</span>filters):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>...    mapped_boolean_dfs <span class="op">=</span> [f(df) <span class="cf">for</span> f <span class="kw">in</span> filters <span class="cf">if</span> <span class="bu">callable</span>(f)]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>...    accumulated_boolean_df <span class="op">=</span> functools.<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, d: acc <span class="op">&amp;</span> d, mapped_boolean_dfs)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>...    <span class="cf">return</span> df[accumulated_boolean_df]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> intersection(tips, is_dinner_time, is_tip_above_five)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>     total_bill    tip     sex smoker  day    time  size</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></span></code></pre></div>
<p>Much better. Now, should we want to add additional fields in the
table to filter with, we merely define more filter functions -- which,
again, can be used for any table.</p>
<p>Please note that each functions can be as complicated as we want, as
long as they return a dataframe of booleans the same size as the
input.</p>
<p>For example, if we are querying string data that is messy, we could
write a filter like the following:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> is_dinner_fuzzy(df):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>...    <span class="cf">return</span> df[<span class="st">&#39;time&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: fuzz.ratio(x, <span class="st">&#39;dinner&#39;</span>)) <span class="op">&gt;=</span> <span class="dv">90</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> intersection(tips, is_dinner_fuzzy, is_tip_above_five)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>     total_bill    tip     sex smoker  day    time  size</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dv">23</span>        <span class="fl">39.42</span>   <span class="fl">7.58</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="dv">44</span>        <span class="fl">30.40</span>   <span class="fl">5.60</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="dv">47</span>        <span class="fl">32.40</span>   <span class="fl">6.00</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="dv">52</span>        <span class="fl">34.81</span>   <span class="fl">5.20</span>  Female     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="dv">116</span>       <span class="fl">29.93</span>   <span class="fl">5.07</span>    Male     No  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No  Sun  Dinner     <span class="dv">5</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="dv">172</span>        <span class="fl">7.25</span>   <span class="fl">5.15</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="dv">181</span>       <span class="fl">23.33</span>   <span class="fl">5.65</span>    Male    Yes  Sun  Dinner     <span class="dv">2</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="dv">183</span>       <span class="fl">23.17</span>   <span class="fl">6.50</span>    Male    Yes  Sun  Dinner     <span class="dv">4</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="dv">211</span>       <span class="fl">25.89</span>   <span class="fl">5.16</span>    Male    Yes  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No  Sat  Dinner     <span class="dv">4</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="dv">214</span>       <span class="fl">28.17</span>   <span class="fl">6.50</span>  Female    Yes  Sat  Dinner     <span class="dv">3</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="dv">239</span>       <span class="fl">29.03</span>   <span class="fl">5.92</span>    Male     No  Sat  Dinner     <span class="dv">3</span></span></code></pre></div>
<p>(Note: <code>fuzz.ratio()</code> returns an integer representing the
<a
href="/https://en.wikipedia.org/wiki/Levenshtein_distance">Levenshtein
distance</a> from one string to another)</p>
<h2 id="how-general-can-we-go">How General Can We Go?</h2>
<p>Is our intersection general enough? What if we wanted to query our
data but instead of using a SQL-like <code>AND</code> operation, we
wanted an <code>OR</code> operation?</p>
<p>Let's generalize further:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">&amp;</span> x):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>...    mapped_dfs <span class="op">=</span> [f(df) <span class="cf">for</span> f <span class="kw">in</span> filters <span class="cf">if</span> <span class="bu">callable</span>(f)]</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>...    accumulated_df <span class="op">=</span> functools.<span class="bu">reduce</span>(reducer, mapped_dfs)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>...    <span class="cf">return</span> df[accumulated_df]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> intersection(df, <span class="op">*</span>filters):</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>...    <span class="cf">return</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">&amp;</span> x)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> union(df, <span class="op">*</span>filters):</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>...    <span class="cf">return</span> filter_reduce(df, <span class="op">*</span>filters, reducer<span class="op">=</span><span class="kw">lambda</span> acc, x: acc <span class="op">|</span> x)</span></code></pre></div>
<p>Then we can represent the following SQL query (from the Pandas
documentation) like so:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode SQL"><code class="sourceCode sql"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> tips</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> <span class="kw">size</span> <span class="op">&gt;=</span> <span class="dv">5</span> <span class="kw">OR</span> total_bill <span class="op">&gt;</span> <span class="dv">45</span>;</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_total_bill_large <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;total_bill&#39;</span>] <span class="op">&gt;</span> <span class="dv">45</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> is_party_gte_five <span class="op">=</span> <span class="kw">lambda</span> df: df[<span class="st">&#39;size&#39;</span>] <span class="op">&gt;=</span> <span class="dv">5</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> union(tips, is_party_gte_five, is_total_bill_large)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>     total_bill    tip     sex smoker   day    time  size</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="dv">59</span>        <span class="fl">48.27</span>   <span class="fl">6.73</span>    Male     No   Sat  Dinner     <span class="dv">4</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="dv">125</span>       <span class="fl">29.80</span>   <span class="fl">4.20</span>  Female     No  Thur   Lunch     <span class="dv">6</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="dv">141</span>       <span class="fl">34.30</span>   <span class="fl">6.70</span>    Male     No  Thur   Lunch     <span class="dv">6</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="dv">142</span>       <span class="fl">41.19</span>   <span class="fl">5.00</span>    Male     No  Thur   Lunch     <span class="dv">5</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="dv">143</span>       <span class="fl">27.05</span>   <span class="fl">5.00</span>  Female     No  Thur   Lunch     <span class="dv">6</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="dv">155</span>       <span class="fl">29.85</span>   <span class="fl">5.14</span>  Female     No   Sun  Dinner     <span class="dv">5</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="dv">156</span>       <span class="fl">48.17</span>   <span class="fl">5.00</span>    Male     No   Sun  Dinner     <span class="dv">6</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="dv">170</span>       <span class="fl">50.81</span>  <span class="fl">10.00</span>    Male    Yes   Sat  Dinner     <span class="dv">3</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="dv">182</span>       <span class="fl">45.35</span>   <span class="fl">3.50</span>    Male    Yes   Sun  Dinner     <span class="dv">3</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="dv">185</span>       <span class="fl">20.69</span>   <span class="fl">5.00</span>    Male     No   Sun  Dinner     <span class="dv">5</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="dv">187</span>       <span class="fl">30.46</span>   <span class="fl">2.00</span>    Male    Yes   Sun  Dinner     <span class="dv">5</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="dv">212</span>       <span class="fl">48.33</span>   <span class="fl">9.00</span>    Male     No   Sat  Dinner     <span class="dv">4</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dv">216</span>       <span class="fl">28.15</span>   <span class="fl">3.00</span>    Male    Yes   Sat  Dinner     <span class="dv">5</span></span></code></pre></div>
<p>Sure, we could have implemented the <code>union</code> and
<code>intersection</code> cases by themselves, but the function
<code>filter_reduce</code> offers us the luxury of adaptability later
on.</p>
<h2 id="beyond-querying">Beyond Querying</h2>
<p>Can this perspective help with other problems besides querying?</p>
<p>Often, we need to mutate dataframes. We might want to add a column of
derived values, or change a column's data type. Mutability, however,
comes with several challenges: What if we make a mistake when mutating
the dataframe, and we would like to revert to the previous form? What if
we wanted to know what the original data looked like?</p>
<p>In Pandas, we can simulate immutability by creating mapping functions
that first perform a shallow copy of the input dataframe and return a
new result.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> add_subtotal(df):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>...     cp[<span class="st">&#39;subtotal&#39;</span>] <span class="op">=</span> cp[<span class="st">&#39;total_bill&#39;</span>] <span class="op">-</span> cp[<span class="st">&#39;tip&#39;</span>]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>...     <span class="cf">return</span> cp</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips1 <span class="op">=</span> add_subtotal(tips)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips1.head()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   total_bill   tip     sex smoker  day    time  size  subtotal</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male     No  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male     No  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female     No  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> add_avg_bill(df): </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>...     cp[<span class="st">&#39;price_per_person&#39;</span>] <span class="op">=</span> cp[<span class="st">&#39;subtotal&#39;</span>] <span class="op">/</span> cp[<span class="st">&#39;size&#39;</span>]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>...     <span class="cf">return</span> cp</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips2 <span class="op">=</span> add_avg_bill(tips1)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips2.head()</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>   total_bill   tip     sex smoker  day    time  size  subtotal  <span class="op">\</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male     No  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male     No  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male     No  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female     No  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>   price_per_person  </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>          <span class="fl">7.990000</span>  </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>          <span class="fl">2.893333</span>  </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>          <span class="fl">5.836667</span>  </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>         <span class="fl">10.185000</span>  </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>          <span class="fl">5.245000</span>  </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> yesno_to_bool(df, column<span class="op">=</span><span class="st">&#39;smoker&#39;</span>):</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>...     cp <span class="op">=</span> pd.DataFrame(df, copy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>...     cp[column] <span class="op">=</span> cp[column].<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="op">==</span> <span class="st">&#39;Yes&#39;</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>...     <span class="cf">return</span> cp</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips3 <span class="op">=</span> yesno_to_bool(tips2, <span class="st">&#39;smoker&#39;</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips3.head()</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>Out[<span class="dv">52</span>]: </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>   total_bill   tip     sex  smoker  day    time  size  subtotal  <span class="op">\</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>   price_per_person  </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>          <span class="fl">7.990000</span>  </span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>          <span class="fl">2.893333</span>  </span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>          <span class="fl">5.836667</span>  </span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>         <span class="fl">10.185000</span>  </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>          <span class="fl">5.245000</span>  </span></code></pre></div>
<p>...</p>
<p>We can combine all of these -- and arbitrarily more operations --
through a higher order function called <code>compose</code>:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> functools</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="kw">def</span> compose(df, <span class="op">*</span>mappers):</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>...     <span class="cf">return</span> functools.<span class="bu">reduce</span>(<span class="kw">lambda</span> acc, x: x(acc), mappers, df)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_all <span class="op">=</span> compose(tips, add_subtotal, add_avg_bill, <span class="kw">lambda</span> x: yesno_to_bool(x, <span class="st">&#39;smoker&#39;</span>))</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_all.head()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   total_bill   tip     sex  smoker  day    time  size  subtotal  <span class="op">\</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>       <span class="fl">16.99</span>  <span class="fl">1.01</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">15.98</span>   </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>       <span class="fl">10.34</span>  <span class="fl">1.66</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>      <span class="fl">8.68</span>   </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>       <span class="fl">21.01</span>  <span class="fl">3.50</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">3</span>     <span class="fl">17.51</span>   </span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>       <span class="fl">23.68</span>  <span class="fl">3.31</span>    Male   <span class="va">False</span>  Sun  Dinner     <span class="dv">2</span>     <span class="fl">20.37</span>   </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>       <span class="fl">24.59</span>  <span class="fl">3.61</span>  Female   <span class="va">False</span>  Sun  Dinner     <span class="dv">4</span>     <span class="fl">20.98</span>   </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>   price_per_person  </span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>          <span class="fl">7.990000</span>  </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>          <span class="fl">2.893333</span>  </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>          <span class="fl">5.836667</span>  </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>         <span class="fl">10.185000</span>  </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>          <span class="fl">5.245000</span>  </span></code></pre></div>
<p>One advantage of this approach is that mutating dataframes can be
lazily evaluated: We can wait to modify the data only until it's needed
(i.e. until we call <code>compose</code>).</p>
<p>Another advantage is that we preserve all the intermediate states of
the data. Further, we have complete flexibility as to what mappings get
applied. Decide that we want to keep the <code>smokers</code> column as
strings again? -- Just remove the <code>yesno_to_bool</code> function.
Decide that you'd rather map it to <code>int</code>s? -- Simply swap out
the function. Just like the filter functions, these mappers can be
applied to any dataframe, provided they have the correct columns.</p>
<p>It's worth wondering: Is copying all of the data inefficient? Surely,
we don't want to duplicate the data all over the place, especially if
the corpus is large.</p>
<p>Pandas addresses this in a very clever manner. The constructor
performs a lazy copy! The copied dataframes store references to the
original values. Only when the data gets mutated does it decide to
allocate new memory. In other words, only the <em>differences</em> from
one dataframe to another are stored. Thus, representing transformations
with copies remains efficient while promoting many other benefits.</p>
<p>Don't take my word for it! Let's prove that this is the case:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_ref_original <span class="op">=</span> tips.applymap(<span class="bu">id</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_ref_copied <span class="op">=</span> tips_all.applymap(<span class="bu">id</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_ref_original.head()</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    total_bill              tip              sex           smoker  <span class="op">\</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>  <span class="dv">139919566582840</span>  <span class="dv">139919566583392</span>  <span class="dv">139919566677192</span>  <span class="dv">139919567009976</span>   </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">139919566584736</span>  <span class="dv">139919566583416</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">139919566584760</span>  <span class="dv">139919566583440</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>  <span class="dv">139919566584808</span>  <span class="dv">139919566583464</span>  <span class="dv">139919567011768</span>  <span class="dv">139919567009976</span>   </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>  <span class="dv">139919566584832</span>  <span class="dv">139919566583488</span>  <span class="dv">139919566677192</span>  <span class="dv">139919567009976</span>   </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>               day             time            size  </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979424</span>  </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_ref_copied.head()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>        total_bill              tip              sex          smoker  <span class="op">\</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>  <span class="dv">139919450679696</span>  <span class="dv">139919450735360</span>  <span class="dv">139919566677192</span>  <span class="dv">94289170711232</span>   </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">139919450679720</span>  <span class="dv">139919450735336</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">139919450679744</span>  <span class="dv">139919450735312</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>  <span class="dv">139919450679768</span>  <span class="dv">139919450735288</span>  <span class="dv">139919567011768</span>  <span class="dv">94289170711232</span>   </span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>  <span class="dv">139919450679792</span>  <span class="dv">139919450735264</span>  <span class="dv">139919566677192</span>  <span class="dv">94289170711232</span>   </span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>               day             time            size         subtotal  <span class="op">\</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  <span class="dv">139919450679696</span>   </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  <span class="dv">139919450679720</span>   </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979392</span>  <span class="dv">139919450679744</span>   </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979360</span>  <span class="dv">139919450679768</span>   </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>  <span class="dv">139919567011600</span>  <span class="dv">139919567008184</span>  <span class="dv">94289170979424</span>  <span class="dv">139919450679792</span>   </span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>   price_per_person  </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>   <span class="dv">139919450735360</span>  </span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>   <span class="dv">139919450735336</span>  </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>   <span class="dv">139919450735312</span>  </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>   <span class="dv">139919450735288</span>  </span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>   <span class="dv">139919450735264</span>  </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_xor <span class="op">=</span> tips_ref_original <span class="op">^</span> tips_ref_copied</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> tips_xor.head()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>   day  price_per_person  sex  size          smoker  subtotal  time  <span class="op">\</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>    <span class="dv">0</span>               NaN    <span class="dv">0</span>     <span class="dv">0</span>  <span class="dv">46733414398584</span>       NaN     <span class="dv">0</span>   </span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>         tip  total_bill  </span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>  <span class="dv">423146848</span>   <span class="dv">423075240</span>  </span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>  <span class="dv">423146640</span>   <span class="dv">423072264</span>  </span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>  <span class="dv">423146560</span>   <span class="dv">423072376</span>  </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>  <span class="dv">423146512</span>   <span class="dv">423072304</span>  </span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>  <span class="dv">423146592</span>   <span class="dv">423073264</span>  </span></code></pre></div>
<footer>
    <ul>
        <li><a href="mailto:al@merose.com">email</a></li>
        <li><a href="https://github.com/alxmrs">github</a></li>
        <li><a href="https://bsky.app/profile/al.merose.com">bsky</a></li>
        <li><a href="https://scholar.google.com/citations?user=9ic0HRsAAAAJ&hl=en">scholar</a></li>
        <li><a href="/rss.xml">rss</a></li>
    </ul>
</footer>
<!-- Verification of Mastodon account -->
<link href="https://hachyderm.io/@al_merose" rel="me">
<!-- Cloudflare Web Analytics -->
<script defer src='https://static.cloudflareinsights.com/beacon.min.js'
        data-cf-beacon='{"token": "6fc27704d9c24c83a33c91f26a5fdcc4"}'>
</script>
<!-- End Cloudflare Web Analytics -->
</body>
</html>
